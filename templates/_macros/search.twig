{#
 |------------------------------------------------------------------------------
 | Pagination for search
 | NearbyPagesLimit - number of pagination button to show before and after the active pagination button
 |------------------------------------------------------------------------------
#}
{% macro pagination(pageInfo, nearbyPagesLimit = 4) %}
	{% set total = pageInfo.totalPages %}
	{% set current = pageInfo.currentPage %}
	{% if total > 1 %}
		<div class="row text-center">
			<ul class="pagination">
				{# Pagination Previous Button, Output only if first button is not active #}
				{% if pageInfo.prevUrl %}
					<li>
						<a href="{{ pageInfo.prevUrl }}" rel="prev">{{ 'Previous Page'|t }}</a>
					</li>
				{% endif %}

                {# Output pagination number #}
				{% for i in 1..total %}
                    {% if not(0 < (current - nearbyPagesLimit) - loop.index) and not(0 > (current + nearbyPagesLimit) - loop.index) %}
						{# Output pagination Last Page Number #}
						<li {{ current == loop.index ? 'class="active"' }}>
							{% if current == loop.index  %}
								<span>{{ loop.index }}</span>
							{% else %}
								<a href="{{ pageInfo.getPageUrl( loop.index ) }}">{{ loop.index }}</a>
							{% endif %}
						</li>
					{% endif %}
				{% endfor %}

				{# Output pagination next button #}
				{% if pageInfo.nextUrl %}
					<li class="next">
						<a href="{{ pageInfo.nextUrl }}" rel="next">{{ 'Next Page'|t }}</a>
					</li>
				{% endif %}
			</ul>
		</div>
	{% endif %}
{% endmacro %}

{#
 |------------------------------------------------------------------------------
 | Make searching keyword bold and with a maximum of word for the summary
 |------------------------------------------------------------------------------
#}
{% macro setSummaryBold(entry, text, word, numWord = 70) %}
	{% set output = "" %}
	{% set texts = text|split(' ') %}
	{% set words = word|split(' ') %}

	{% if texts|length > numWord %}
		{% set firstMatchingWord = 0 %}
		{% for text in texts %}
			{# Find first position of the word in array #}
			{% if words[0]|lower in text|lower %}
			    {% set firstMatchingWord = loop.index - 1 %}
			{% endif %}
		{% endfor %}

		{% set firstPeriod = 0 %}
		{% set break = false %}
		{# Find first position of the last period before search keyword. This makes the summary nicer  #}
		{% for text in texts if not break %}
			{% if '.' in text %}
				{% set firstPeriod = loop.index %}
				{% if (firstMatchingWord - firstPeriod) < numWord %}
					{% set firstPeriod = loop.index %}
					{# When we find the first period, we can get out of the loop #}
                    {% set break = true %}
				{% endif %}
			{% endif %}
		{% endfor %}
		{# Concatenate string to the maximum number of word allowed from the end of the last sentence #}
		{% for text in texts|slice(firstPeriod, numWord) %}
			{% set output = output ~ ' ' ~ text %}
		{% endfor %}
	{% else %}
		{# Join string if number of word in that page is less than the maxmium number of word allowed #}
		{% set output = texts|join(' ') %}
	{% endif %}

    {# Make the searching keyword bold #}
	{% set output = output|lower|replace(word|lower, '<strong>' ~ word ~ '</strong>') %}
	{# Output the summary with the updated date, Canada.ca output the date and ... even if the summary is empty #}
	<p>
        {{ entry.dateUpdated|date("Y-m-d") }}...
        {% if output %}
            {{ output|raw }}...
        {% endif %}
    </p>
{% endmacro %}

{#
 |------------------------------------------------------------------------------
 | This function is looking for the keyword query in the title and on the redactor field
 |------------------------------------------------------------------------------
#}
{% macro getPageBuilderBlockContent(entry, searchQuery) %}
	{% import _self as searchMacro %}
    {% set output = ""  %}
	{% set findMatchWord = false %}
	{% for block in entry.pageBuilder.all() %}
		{# Check if element title had the search keyword #}
		{% if searchQuery|lower in block.elementTitle|lower %}
			{% set findMatchWord = true %}
            {% set output = output ~ ' ' ~ block.elementTitle|striptags %}
		{% endif %}
        {# Append block.redactor to string #}
		{% if searchQuery|lower in block.redactor|lower %}
            {% set output = output ~ ' ' ~ block.redactor|striptags %}
		{% endif %}
	{% endfor %}
    {{ searchMacro.setSummaryBold(entry, output, searchQuery) }}
{% endmacro %}
